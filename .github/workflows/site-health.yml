name: Site Health Check

on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes (UTC)
  workflow_dispatch: {}

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: pip install -q requests

      - name: Run health checks
        env:
          URL_EDGE: "https://sf.epochtimes.com/favicon.ico"
          URL_APP: "https://sf.epochtimes.com/timeline"          # TODO: Êç¢ÊàêÂõ∫ÂÆöÊñáÁ´†È°µ
          MAX_MS_EDGE: "800"
          MAX_MS_APP: "1500"
          RETRIES: "3"
          TIMEOUT: "5"
        run: python check.py


      - name: Notify Telegram on failure
        if: failure()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TEXT="üö® ET site health check FAILED
          Site: sf.epochtimes.com
          Repo: $GITHUB_REPOSITORY
          Workflow: $GITHUB_WORKFLOW
          Run: $GITHUB_RUN_ID
          Link: https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            --data-urlencode text="$TEXT" \
            -d disable_web_page_preview=true